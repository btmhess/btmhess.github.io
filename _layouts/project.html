---
layout: default
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | Projects Portfolio</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body class="project-page">

<header>
  <nav>
    <div>
      <a href="/">Home</a>
    </div>
    <h1>{{ page.title }}</h1>
  </nav>
</header>

<main>

  <!-- Banner image -->
  <div id="banner">
    <img src="/assets/projects/{{ page.project_slug }}/thumbnail.jpg" 
         alt="{{ page.title }} banner">
  </div>

  <!-- Project metadata -->
  <div>
   <span><h2>{{ page.title }}</h2></span>
    <span><strong>Date:</strong> {{ page.project_date }}</span> |
	<span><strong>Duration:</strong> {{ page.duration }} weeks</span> |
    <span><strong>Status:</strong> {{ page.status }}</span> |
    <span><strong>Budget:</strong> ${{ page.budget }}</span>
  </div>
  
  <section>
    <h2>Goal</h2>
	<p>{{ page.goal }}</p>
    <h2>Requirements</h2>
    <p>{{ page.requirements }}</p>
    <h2>Result / Current Incarnation</h2>
    <p>{{ page.result }}</p>
    <h2>Specifications</h2>
    <p>{{ page.specifications }}</p>
  </section>
  
  {% if page.related_projects %}
    <h2>Related Projects</h2>
      {% for slug in page.related_projects %}
      {% assign related = site.projects | where: "project_slug", slug | first %}
      {% if related %}
        <a href="{{ related.url }}">{{ related.title }}</a>{% unless forloop.last %}, {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <!-- Gallery -->
  <h2>Gallery</h2>
  <div id="gallery"></div>

  <!-- Materials -->
  <h2>Materials / Parts List</h2>
  <div id="materials-table"></div>
  
</main>

<!-- Lightbox overlay -->
<div id="lightbox-overlay">
  <img id="lightbox-img" src="" alt="">
  <div id="lightbox-controls">
    <button id="prev-btn">&larr; Prev</button>
    <button id="next-btn">Next &rarr;</button>
    <button id="close-btn">Close</button>
  </div>
</div>

{% comment %}
  Generate the media array from static files
{% endcomment %}
{% assign project_base = "assets/projects/" | append: page.project_slug | append: "/" %}
{% assign media_files = "" | split: "" %}

{% for f in site.static_files %}
  {% assign path_lower = f.path | downcase %}
  {% if path_lower contains project_base and (path_lower contains "/thumbs/" == false) %}
    {% assign ext = f.extname | downcase %}
    {% if ext == ".jpg" or ext == ".jpeg" or ext == ".png" or ext == ".webp" or ext == ".mp4" or ext == ".webm" %}
      {% capture media_item %}
        {
          name: "{{ f.name }}",
          type: "{% if ext == '.mp4' or ext == '.webm' %}video{% else %}image{% endif %}"
        }
      {% endcapture %}
      {% assign media_files = media_files | push: media_item %}
    {% endif %}
  {% endif %}
{% endfor %}

<script>
(function() {
  const galleryContainer = document.getElementById("gallery");
  const overlay = document.getElementById("lightbox-overlay");
  const lightboxImg = document.getElementById("lightbox-img");

  // Persistent video element
  const videoEl = document.createElement("video");
  videoEl.controls = true;
  videoEl.playsInline = true;
  videoEl.style.maxWidth = "90vw";
  videoEl.style.maxHeight = "80vh";
  videoEl.style.display = "none";
  overlay.insertBefore(videoEl, overlay.firstChild);

  const basePath = "/assets/projects/{{ page.project_slug }}/";
  const thumbPath = basePath + "thumbs/";

  // Liquid-generated array of media objects
  const media = [{{ media_files | join: "," }}];

  if (!media.length) return;

  let currentIndex = 0;

  // Helper to preload images (for faster next/prev navigation)
  function preloadImage(url) {
    const img = new Image();
    img.src = url;
  }

  // Build gallery thumbnails
  media.forEach((item, index) => {
    const img = document.createElement("img");
    img.loading = "lazy";
    img.className = "gallery-thumb";
    img.dataset.index = index;

    // Thumbnails always .jpg in /thumbs/
    const baseName = item.name.replace(/\.[^/.]+$/, "");
    img.src = thumbPath + baseName + ".jpg";
    img.alt = item.name;
    galleryContainer.appendChild(img);
  });

  // Open lightbox
  function open(index) {
    currentIndex = index;
    overlay.style.display = "flex";

    const item = media[currentIndex];
    const fullSrc = basePath + item.name;

    // Reset
    lightboxImg.style.display = "none";
    lightboxImg.src = "";
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.style.display = "none";

    if (item.type === "image") {
      lightboxImg.src = fullSrc;
      lightboxImg.style.display = "block";

      // Preload neighbors
      const nextIndex = (currentIndex + 1) % media.length;
      const prevIndex = (currentIndex - 1 + media.length) % media.length;
      [nextIndex, prevIndex].forEach(i => {
        if (media[i].type === "image") preloadImage(basePath + media[i].name);
      });

    } else if (item.type === "video") {
      videoEl.src = fullSrc;
      videoEl.style.display = "block";
      videoEl.play();
    }
  }

  function close() {
    overlay.style.display = "none";
    lightboxImg.style.display = "none";
    lightboxImg.src = "";
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.style.display = "none";
  }

  function next() { open((currentIndex + 1) % media.length); }
  function prev() { open((currentIndex - 1 + media.length) % media.length); }

  // Event listeners
  galleryContainer.addEventListener("click", e => {
    if (e.target.tagName === "IMG") open(parseInt(e.target.dataset.index));
  });

  document.getElementById("next-btn").onclick = next;
  document.getElementById("prev-btn").onclick = prev;
  document.getElementById("close-btn").onclick = close;

  overlay.addEventListener("click", e => {
    if (e.target === overlay) close();
  });

})();
</script>



<script>
// Materials CSV loader
(async function () {
  const container = document.getElementById("materials-table");
  const projectSlug = "{{ page.project_slug }}";
  const csvUrl = "/assets/projects/" + projectSlug + "/materials.csv";

  try {
    const response = await fetch(csvUrl);
    if (!response.ok) throw new Error("No materials.csv found");

    const text = await response.text();
    const rows = text.trim().split("\n").map(r => r.split(","));

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    const headerRow = document.createElement("tr");
    rows[0].forEach(h => { const th = document.createElement("th"); th.textContent = h.trim(); headerRow.appendChild(th); });
    thead.appendChild(headerRow);

    rows.slice(1).forEach(row => {
      const tr = document.createElement("tr");
      row.forEach(cell => { const td = document.createElement("td"); td.textContent = cell.trim(); tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(table);
  } catch(err) {
    container.innerHTML = "<em>No materials list available.</em>";
    console.warn("Materials table load failed:", err);
  }
})();
</script>

</body>
</html>
