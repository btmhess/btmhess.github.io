---
layout: default
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | Projects Portfolio</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body class="project-page">

<header>
  <nav>
    <div>
      <a href="/">Home</a>
    </div>
    <h1>{{ page.title }}</h1>
  </nav>
</header>

<main>

  <!-- Banner image -->
  <div id="banner">
    <img src="/assets/projects/{{ page.project_slug }}/thumbnail.jpg" 
         alt="{{ page.title }} banner">
  </div>

  <!-- Project metadata -->
  <div>
   <span><h2>{{ page.title }}</h2></span>
    <span><strong>Date:</strong> {{ page.project_date }}</span> |
	<span><strong>Duration:</strong> {{ page.duration }} weeks</span> |
    <span><strong>Status:</strong> {{ page.status }}</span> |
    <span><strong>Budget:</strong> ${{ page.budget }}</span>
  </div>
  
  <section>
	<p>{{ page.goal }}</p>
    <h2>Goal</h2>
    <h2>Requirements</h2>
    <p>{{ page.requirements }}</p>
    <h2>Result / Current Incarnation</h2>
    <p>{{ page.result }}</p>
    <h2>Specifications</h2>
    <p>{{ page.specifications }}</p>
  </section>
  
  {% if page.related_projects %}
    <h2>Related Projects</h2>
      {% for slug in page.related_projects %}
      {% assign related = site.projects | where: "project_slug", slug | first %}
      {% if related %}
        <a href="{{ related.url }}">{{ related.title }}</a>{% unless forloop.last %}, {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <!-- Gallery -->
  <h2>Gallery</h2>
  <div id="gallery"></div>

  <!-- Materials -->
  <h2>Materials / Parts List</h2>
  <div id="materials-table"></div>
  
</main>

<!-- Lightbox overlay -->
<div id="lightbox-overlay">
  <img id="lightbox-img" src="" alt="">
  <div id="lightbox-controls">
    <button id="prev-btn">&larr; Prev</button>
    <button id="next-btn">Next &rarr;</button>
    <button id="close-btn">Close</button>
  </div>
</div>

<script>
(function () {
  const gallery = document.getElementById("gallery");
  const slug = "{{ page.project_slug }}";
  const basePath = "/assets/projects/" + slug + "/";
  const thumbPath = basePath + "thumbs/";

  const media = [
    {% assign base = "assets/projects/" | append: page.project_slug | append: "/" %}
    {% for f in site.static_files %}
      {% if f.path contains base and f.path contains "/thumbs/" == false %}
        {% assign ext = f.extname | downcase %}
        {% if ext == ".jpg" or ext == ".jpeg" or ext == ".png" or ext == ".webp" or ext == ".mp4" or ext == "m4v" or ext == "mkv" %}
          {
            name: "{{ f.name }}",
            type: "{% if ext == ".mp4" or ext == ".m4v" or ext == ".mkv"%}video{% else %}image{% endif %}"
          },
        {% endif %}
      {% endif %}
    {% endfor %}
  ];

  if (!media.length) return;

  let current = 0;

  media.forEach((item, index) => {
    const thumb = document.createElement("img");
    thumb.loading = "lazy";
    thumb.className = "gallery-thumb";
    thumb.dataset.index = index;

    const baseName = item.name.replace(/\.[^/.]+$/, "");
    thumb.src = thumbPath + baseName + ".jpg";
    thumb.alt = item.name;

    gallery.appendChild(thumb);
  });

  const overlay = document.getElementById("lightbox-overlay");
  const lightboxImg = document.getElementById("lightbox-img");

  const videoEl = document.createElement("video");
  videoEl.controls = true;
  videoEl.style.maxWidth = "90vw";
  videoEl.style.maxHeight = "80vh";
  videoEl.style.display = "none";
  overlay.insertBefore(videoEl, overlay.firstChild);

  function open(index) {
    current = index;
    overlay.style.display = "flex";

    const item = media[current];
    const src = basePath + item.name;

    // reset elements
    lightboxImg.style.display = "none";
    lightboxImg.src = "";
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.style.display = "none";

    if (item.type === "image") {
      lightboxImg.src = src;
      lightboxImg.style.display = "block";

      // ===== Preload neighbors =====
      const nextIndex = (current + 1) % media.length;
      const prevIndex = (current - 1 + media.length) % media.length;

      [nextIndex, prevIndex].forEach(i => {
        if (media[i].type === "image") {
          preloadImage(basePath + media[i].name);
        }
      });

    } else {
      videoEl.src = src;
      videoEl.style.display = "block";
      videoEl.play();
      // optional: preload video poster for neighbors
    }
  }


  function close() {
    overlay.style.display = "none";
    lightboxImg.src = "";
    lightboxImg.style.display = "none";
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.load();
    videoEl.style.display = "none";
  }

  function next() { open((current + 1) % media.length); }
  function prev() { open((current - 1 + media.length) % media.length); }
  function preloadImage(url) {
    const img = new Image();
    img.src = url; // browser fetches and caches
  }

  gallery.addEventListener("click", e => {
    if (e.target.tagName === "IMG") {
      open(parseInt(e.target.dataset.index));
    }
  });

  document.getElementById("next-btn").onclick = next;
  document.getElementById("prev-btn").onclick = prev;
  document.getElementById("close-btn").onclick = close;

  overlay.addEventListener("click", e => {
    if (e.target === overlay) close();
  });
})();
</script>



<script>
// Materials CSV loader
(async function () {
  const container = document.getElementById("materials-table");
  const projectSlug = "{{ page.project_slug }}";
  const csvUrl = "/assets/projects/" + projectSlug + "/materials.csv";

  try {
    const response = await fetch(csvUrl);
    if (!response.ok) throw new Error("No materials.csv found");

    const text = await response.text();
    const rows = text.trim().split("\n").map(r => r.split(","));

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    const headerRow = document.createElement("tr");
    rows[0].forEach(h => { const th = document.createElement("th"); th.textContent = h.trim(); headerRow.appendChild(th); });
    thead.appendChild(headerRow);

    rows.slice(1).forEach(row => {
      const tr = document.createElement("tr");
      row.forEach(cell => { const td = document.createElement("td"); td.textContent = cell.trim(); tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(table);
  } catch(err) {
    container.innerHTML = "<em>No materials list available.</em>";
    console.warn("Materials table load failed:", err);
  }
})();
</script>

</body>
</html>
